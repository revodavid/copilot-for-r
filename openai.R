library(jsonlite)
library(httr2)
library(glue)
library(stringr)

# retrieve API key from file and save to environment variable
MY_OPENAI_API_KEY <- readLines("openai_key.txt")
Sys.setenv(OPENAI_API_KEY = MY_OPENAI_API_KEY)

# Edit the following line with the endpoint of the API.
# You can find this in the Azure portal under "Keys and Endpoint".
MY_ENDPOINT <- "https://openai-test-20230120.openai.azure.com/"

# Edit the following line with the model you want to use.
# You can find options in the Azure portal under "Model Deployments"
MY_DEPLOYMENT <- "text-davinci-002"

openai <- function(prompt, temperature=1,top_p=0.5,max_tokens=100,stop="null",
    OPENAI_API_KEY=MY_OPENAI_API_KEY,
    ENDPOINT=MY_ENDPOINT,
    DEPLOYMENT=MY_DEPLOYMENT) {
    # openai(prompt) returns a string of text generated by the OpenAI API
    # prompt: a string of text to prompt the API with (Do not include single quotes)
    # value: a string of text generated by the OpenAI API
    # 
    # Example:
    # openai("The quick brown fox jumps over the lazy dog. Translate into French:")
     

    req <- request(ENDPOINT)
    req %>%
        req_url_path_append("openai/deployments") %>%
        req_url_path_append(DEPLOYMENT) %>%
        req_url_path_append("completions") %>%
        req_url_query("api-version"="2022-12-01")

    payload <- paste0('{
    "prompt": "', prompt, '",
    "max_tokens": ',max_tokens,',
    "temperature": ', temperature, ',
    "frequency_penalty": 0,
    "presence_penalty": 0,
    "top_p": ', top_p, ',
    "best_of": 1,
    "stop": ',stop,', 
    }')

    req <- request(target_url) %>%
        req_headers(
            `api-key` = OPENAI_API_KEY,
        ) %>% 
        req_body_raw(payload, "application/json") 

    result <- req %>% req_perform() %>% resp_body_json() 
    completion <- result$choices[[1]]$text
    output <- str_trim(completion)
    cat(output,"\n")
    return(invisible(completion))
}

openai("tell me a joke")
openai("Your favorite number is 5. Pick a number between 1 and 10. Go:", top_p=1)
openai("Complete this sentence: The best flavor of ice cream is ", top_p=0.9)
